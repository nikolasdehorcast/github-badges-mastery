name: ðŸ† Badge Progress Tracker

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 12 * * *'  # DiÃ¡rio ao meio-dia UTC
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o completa'
        required: false
        default: false
        type: boolean

env:
  BADGE_REPORT_PATH: 'badge-progress-report.md'

jobs:
  track-pull-shark:
    name: ðŸ¦ˆ Track Pull Shark Progress
    runs-on: ubuntu-latest
    outputs:
      pr_count: ${{ steps.count_prs.outputs.count }}
      status: ${{ steps.check_status.outputs.status }}
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ” Count merged PRs
      id: count_prs
      run: |
        # Simular contagem de PRs (em repo real usaria GitHub API)
        pr_count=$(find .github -name "*.yml" | wc -l)
        echo "count=$pr_count" >> $GITHUB_OUTPUT
        echo "ðŸ“Š PRs simulados: $pr_count"
        
    - name: âœ… Check Pull Shark status
      id: check_status
      run: |
        pr_count="${{ steps.count_prs.outputs.count }}"
        if [ "$pr_count" -ge 2 ]; then
          echo "status=completed" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ Pull Shark: CONQUISTADA!"
        else
          echo "status=in-progress" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Pull Shark: Em progresso ($pr_count/2)"
        fi

  track-pair-extraordinaire:
    name: ðŸ‘¥ Track Pair Extraordinaire Progress
    runs-on: ubuntu-latest
    outputs:
      coauthor_count: ${{ steps.count_coauthors.outputs.count }}
      status: ${{ steps.check_status.outputs.status }}
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ” Count co-authored commits
      id: count_coauthors
      run: |
        coauthor_count=$(git log --grep="Co-authored-by" --oneline | wc -l)
        echo "count=$coauthor_count" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Commits com co-autoria: $coauthor_count"
        
    - name: âœ… Check Pair Extraordinaire status
      id: check_status
      run: |
        coauthor_count="${{ steps.count_coauthors.outputs.count }}"
        if [ "$coauthor_count" -ge 1 ]; then
          echo "status=completed" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ Pair Extraordinaire: CONQUISTADA!"
        else
          echo "status=pending" >> $GITHUB_OUTPUT
          echo "â³ Pair Extraordinaire: Pendente"
        fi

  track-devops-guru:
    name: âš™ï¸ Track DevOps Guru Progress
    runs-on: ubuntu-latest
    outputs:
      workflow_count: ${{ steps.count_workflows.outputs.count }}
      status: ${{ steps.check_status.outputs.status }}
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ” Count workflows
      id: count_workflows
      run: |
        workflow_count=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
        echo "count=$workflow_count" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Workflows configurados: $workflow_count"
        
    - name: âœ… Check DevOps Guru status
      id: check_status
      run: |
        workflow_count="${{ steps.count_workflows.outputs.count }}"
        if [ "$workflow_count" -ge 1 ]; then
          echo "status=completed" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ DevOps Guru: CONQUISTADA!"
        else
          echo "status=pending" >> $GITHUB_OUTPUT
          echo "â³ DevOps Guru: Pendente"
        fi

  generate-report:
    name: ðŸ“Š Generate Badge Report
    runs-on: ubuntu-latest
    needs: [track-pull-shark, track-pair-extraordinaire, track-devops-guru]
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Generate comprehensive report
      run: |
        cat > ${{ env.BADGE_REPORT_PATH }} << 'EOF'
        # ðŸ† Badge Progress Report
        
        **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
        **Workflow:** Badge Progress Tracker  
        **Run:** ${{ github.run_number }}
        
        ## ðŸ“‹ Badge Status Overview
        
        | Badge | Status | Progress | Details |
        |-------|--------|----------|---------|
        | ðŸ¦ˆ Pull Shark | ${{ needs.track-pull-shark.outputs.status }} | ${{ needs.track-pull-shark.outputs.pr_count }}/2 PRs | Merged pull requests |
        | ðŸ‘¥ Pair Extraordinaire | ${{ needs.track-pair-extraordinaire.outputs.status }} | ${{ needs.track-pair-extraordinaire.outputs.coauthor_count }}+ commits | Co-authored commits |
        | âš™ï¸ DevOps Guru | ${{ needs.track-devops-guru.outputs.status }} | ${{ needs.track-devops-guru.outputs.workflow_count }}+ workflows | GitHub Actions |
        | ðŸ§  Galaxy Brain | pending | 0/1 discussions | Accepted discussions |
        | âš¡ Quickdraw | in-progress | Auto-created | Issues/PRs < 5min |
        | â¤ï¸ Heart On Your Sleeve | pending | 0+ reactions | Issue/PR reactions |
        | ðŸŽ² YOLO | pending | 0+ merges | Merge without review |
        
        ## ðŸ“ˆ Progress Summary
        
        - **Completed:** $(echo "${{ needs.track-pull-shark.outputs.status }} ${{ needs.track-pair-extraordinaire.outputs.status }} ${{ needs.track-devops-guru.outputs.status }}" | grep -o "completed" | wc -l)/7 badges
        - **In Progress:** $(echo "${{ needs.track-pull-shark.outputs.status }} ${{ needs.track-pair-extraordinaire.outputs.status }} ${{ needs.track-devops-guru.outputs.status }}" | grep -o "in-progress" | wc -l)/7 badges
        - **Pending:** $(echo "${{ needs.track-pull-shark.outputs.status }} ${{ needs.track-pair-extraordinaire.outputs.status }} ${{ needs.track-devops-guru.outputs.status }}" | grep -o "pending" | wc -l)/7 badges
        
        ## ðŸŽ¯ Next Actions
        
        ### Immediate (Today)
        - [ ] Create and merge PRs for Pull Shark completion
        - [ ] Enable discussions for Galaxy Brain
        - [ ] Create quick issues for Quickdraw
        
        ### Short-term (This Week)
        - [ ] Add reactions to issues for Heart On Your Sleeve
        - [ ] Configure direct merges for YOLO
        - [ ] Optimize existing workflows
        
        ### Long-term (Ongoing)
        - [ ] Monitor badge acquisition
        - [ ] Document successful strategies
        - [ ] Share knowledge with community
        
        ## ðŸ”§ Technical Details
        
        ### Workflow Execution
        - **Trigger:** ${{ github.event_name }}
        - **Branch:** ${{ github.ref_name }}
        - **Commit:** ${{ github.sha }}
        - **Actor:** ${{ github.actor }}
        
        ### Repository Stats
        - **Pull Shark PRs:** ${{ needs.track-pull-shark.outputs.pr_count }}
        - **Co-authored Commits:** ${{ needs.track-pair-extraordinaire.outputs.coauthor_count }}
        - **Active Workflows:** ${{ needs.track-devops-guru.outputs.workflow_count }}
        
        ## ðŸ“ž Support
        
        - **Issues:** Report problems via GitHub Issues
        - **Discussions:** Share strategies via GitHub Discussions
        - **Documentation:** Check `/docs` folder for guides
        
        ---
        
        **ðŸ¤– Automated report generated by GitHub Actions**  
        **ðŸ“… Next update:** Tomorrow at 12:00 UTC  
        **ðŸ”„ Manual trigger:** Use workflow_dispatch
        EOF
        
        echo "ðŸ“„ Report generated successfully!"
        
    - name: ðŸ“¤ Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: badge-progress-report
        path: ${{ env.BADGE_REPORT_PATH }}
        retention-days: 30
        
    - name: ðŸ“‹ Display report summary
      run: |
        echo "## ðŸ“Š Badge Progress Summary"
        echo "- Pull Shark: ${{ needs.track-pull-shark.outputs.status }}"
        echo "- Pair Extraordinaire: ${{ needs.track-pair-extraordinaire.outputs.status }}"
        echo "- DevOps Guru: ${{ needs.track-devops-guru.outputs.status }}"
        echo ""
        echo "ðŸ“„ Full report available in artifacts"

  notify-completion:
    name: ðŸ”” Notify Completion
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: always()
    steps:
    - name: ðŸŽ‰ Success notification
      if: success()
      run: |
        echo "âœ… Badge tracking completed successfully!"
        echo "ðŸ“Š Report generated and uploaded"
        echo "ðŸ”„ Next run scheduled for tomorrow"
        
    - name: âŒ Failure notification
      if: failure()
      run: |
        echo "âŒ Badge tracking failed!"
        echo "ðŸ” Check workflow logs for details"
        echo "ðŸ› ï¸ Manual intervention may be required"
        
    - name: âš ï¸ Cancelled notification
      if: cancelled()
      run: |
        echo "âš ï¸ Badge tracking was cancelled"
        echo "ðŸ”„ Will retry on next trigger"
